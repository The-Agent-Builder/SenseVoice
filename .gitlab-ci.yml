# SenseVoice GitLab CI/CD Pipeline
# 支持代码质量检查、Docker构建和自动部署

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_REGISTRY: "hub.sensedeal.vip"
  IMAGE_NAME: "${DOCKER_REGISTRY}/ketd/sensevoice"
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # Python 包源配置
  PIP_INDEX_URL: "https://pypi.tuna.tsinghua.edu.cn/simple"
  PIP_TRUSTED_HOST: "pypi.tuna.tsinghua.edu.cn"
  # 部署配置
  DEPLOY_PATH: "/opt/sensevoice"

# 测试阶段
test:
  stage: test
  image: ${DOCKER_REGISTRY}/library/ubuntu-python-base:22.04-20240612
  before_script:
    - pip3 install --upgrade pip -i $PIP_INDEX_URL --trusted-host $PIP_TRUSTED_HOST
    - pip3 install -r requirements.txt -i $PIP_INDEX_URL --trusted-host $PIP_TRUSTED_HOST
  script:
    - echo "运行代码语法检查..."
    - python3 -m py_compile main.py
    - python3 -m py_compile config/settings.py
    - python3 -m py_compile handlers/audio_handler.py
    - python3 -m py_compile models/sense_voice_model.py
    - python3 -m py_compile websocket/connection_manager.py
    - echo "代码语法检查通过"
    - echo "检查项目结构..."
    - ls -la
    - echo "检查必要文件..."
    - test -f requirements.txt && echo "✅ requirements.txt 存在"
    - test -f Dockerfile && echo "✅ Dockerfile 存在"
    - test -f Dockerfile.gpu && echo "✅ Dockerfile.gpu 存在"
    - test -f docker-compose.yml && echo "✅ docker-compose.yml 存在"
    - test -d config && echo "✅ config 目录存在"
    - test -d handlers && echo "✅ handlers 目录存在"
    - test -d models && echo "✅ models 目录存在"
    - test -d websocket && echo "✅ websocket 目录存在"
    - echo "基础测试通过"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_ID

# Docker 镜像构建
build:
  stage: build
  image: ${DOCKER_REGISTRY}/library/docker:27.3.1-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  before_script:
    - export DOCKER_CONFIG=/tmp/.docker
    - mkdir -p $DOCKER_CONFIG
    - echo "{\"auths\":{\"$DOCKER_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > $DOCKER_CONFIG/config.json
  script:
    # 构建 GPU 版本
    - echo "构建 GPU Docker 镜像..."
    - docker build -f Dockerfile.gpu -t ${IMAGE_NAME}:gpu-${IMAGE_TAG} .
    - docker build -f Dockerfile.gpu -t ${IMAGE_NAME}:gpu-latest .

    # 构建 CPU 版本
    - echo "构建 CPU Docker 镜像..."
    - docker build -f Dockerfile -t ${IMAGE_NAME}:cpu-${IMAGE_TAG} .
    - docker build -f Dockerfile -t ${IMAGE_NAME}:cpu-latest .

    # 推送镜像到内网仓库
    - echo "推送镜像到内网仓库..."
    - docker push ${IMAGE_NAME}:gpu-${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:gpu-latest
    - docker push ${IMAGE_NAME}:cpu-${IMAGE_TAG}
    - docker push ${IMAGE_NAME}:cpu-latest

    # 保存镜像文件（用于直接部署）
    - echo "保存 Docker 镜像文件..."
    - docker save ${IMAGE_NAME}:gpu-latest | gzip > sensevoice-gpu-latest.tar.gz
    - docker save ${IMAGE_NAME}:cpu-latest | gzip > sensevoice-cpu-latest.tar.gz

    # 清理构建缓存
    - docker system prune -f
  artifacts:
    paths:
      - sensevoice-gpu-latest.tar.gz
      - sensevoice-cpu-latest.tar.gz
      - docker-compose.deploy.yml
      - docker-compose.yml
      - .env.example
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"



# SSH 部署到服务器
deploy_production:
  stage: deploy
  image: ${DOCKER_REGISTRY}/library/ubuntu-python-base:22.04-20240612
  before_script:
    # 安装必要工具
    - apt-get update -qq && apt-get install -y -qq openssh-client curl bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    # 传输文件到服务器
    - echo "传输文件到服务器..."
    - scp -P $SERVER_PORT sensevoice-gpu-latest.tar.gz sensevoice-cpu-latest.tar.gz docker-compose.yml .env.example $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/temp/

    # 执行部署脚本
    - |
      ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
        set -e

        # 进入部署目录
        cd $DEPLOY_PATH

        # 创建备份
        if [ -f docker-compose.yml ]; then
          echo "创建备份..."
          sudo docker-compose down || true
          cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S) || true
        fi

        # 复制新文件
        cp temp/docker-compose.yml .
        cp temp/.env.example .env

        # 设置GPU设备（如果手动指定）
        if [ "${GPU_DEVICE:-auto}" != "auto" ]; then
          echo "SENSEVOICE_DEVICE=${GPU_DEVICE}" >> .env
          echo "手动设置GPU设备: ${GPU_DEVICE}"
        fi

        # 登录内网Docker仓库
        echo "登录内网Docker仓库..."
        echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

        # 拉取最新镜像
        echo "拉取最新镜像..."
        docker pull ${IMAGE_NAME}:gpu-latest
        docker pull ${IMAGE_NAME}:cpu-latest

        # 清理旧镜像
        echo "清理旧镜像..."
        docker image prune -f || true

        # 启动服务
        echo "启动服务..."
        docker-compose up -d

        # 等待服务启动
        echo "等待服务启动..."
        sleep 30

        # 健康检查
        echo "执行健康检查..."
        for i in {1..10}; do
          if curl -f http://localhost:50000/health; then
            echo "服务健康检查通过!"
            break
          fi
          echo "健康检查尝试 $i 失败，10秒后重试..."
          sleep 10
        done

        # 清理临时文件
        rm -rf temp/

        echo "部署完成!"
      EOF
  after_script:
    # 显示部署状态
    - |
      ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
        cd $DEPLOY_PATH
        echo "=== 部署状态 ==="
        docker-compose ps
        echo "=== 服务日志 (最近20行) ==="
        docker-compose logs --tail=20 sensevoice
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v.*/
    - if: $CI_PIPELINE_SOURCE == "web"
  needs:
    - job: build
  environment:
    name: production
    url: http://$SERVER_HOST:50000

# 手动触发部署
manual_deploy:
  stage: deploy
  extends: deploy_production
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: false
  variables:
    ENVIRONMENT: ${ENVIRONMENT:-production}
    GPU_DEVICE: ${GPU_DEVICE:-cuda}
