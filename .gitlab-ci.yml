# SenseVoice GitLab CI/CD Pipeline
# 支持代码质量检查、Docker构建和自动部署

stages:
  - test
  - build
  - deploy

variables:
  DOCKER_IMAGE_NAME: "sensevoice"
  DEPLOY_PATH: "/opt/sensevoice"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # 内网 Docker 仓库配置
  DOCKER_REGISTRY: "hub.sensedeal.vip"
  DOCKER_IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  # Python 包源配置
  PIP_INDEX_URL: "https://pypi.tuna.tsinghua.edu.cn/simple"
  PIP_TRUSTED_HOST: "pypi.tuna.tsinghua.edu.cn"

# 代码质量检查和测试
code_quality:
  stage: test
  image: ${DOCKER_REGISTRY}/library/ubuntu-python-base:22.04-20240612
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl
    - pip install --upgrade pip -i $PIP_INDEX_URL
    - pip install -r requirements.txt -i $PIP_INDEX_URL
    - pip install flake8 pytest -i $PIP_INDEX_URL
  script:
    # 代码风格检查
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    # 基础导入测试
    - python -c "import config.settings; print('Config import OK')"
    - python -c "import handlers.audio_handler; print('Audio handler import OK')"
    - python -c "import websocket.connection_manager; print('WebSocket manager import OK')"
  rules:
    - if: $CI_PIPELINE_SOURCE == "web" && $FORCE_DEPLOY == "true"
      when: never
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_PIPELINE_SOURCE == "web"

# 简化的语法检查（备用方案）
syntax_check:
  stage: test
  image: ${DOCKER_REGISTRY}/library/ubuntu-python-base:22.04-20240612
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl
    - pip install --upgrade pip -i $PIP_INDEX_URL
  script:
    # 基础语法检查
    - python -m py_compile main.py
    - python -m py_compile config/settings.py
    - python -m py_compile handlers/audio_handler.py
    - echo "语法检查通过"
  rules:
    - if: $CI_PIPELINE_SOURCE == "web" && $FORCE_DEPLOY == "true"
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
      allow_failure: true

# Docker 镜像构建
build_images:
  stage: build
  image: ${DOCKER_REGISTRY}/library/docker:27.3.1
  services:
    - name: ${DOCKER_REGISTRY}/library/docker:27.3.1-dind
      alias: docker
  before_script:
    # 登录内网 Docker 仓库
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY
    - docker info
  script:
    # 构建 GPU 版本
    - echo "构建 GPU Docker 镜像..."
    - docker build -f Dockerfile.gpu -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-$DOCKER_IMAGE_TAG .
    - docker build -f Dockerfile.gpu -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest .

    # 构建 CPU 版本
    - echo "构建 CPU Docker 镜像..."
    - docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-$DOCKER_IMAGE_TAG .
    - docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest .

    # 推送镜像到内网仓库
    - echo "推送镜像到内网仓库..."
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-$DOCKER_IMAGE_TAG
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-$DOCKER_IMAGE_TAG
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest

    # 保存镜像文件（用于直接部署）
    - echo "保存 Docker 镜像文件..."
    - docker save $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest | gzip > sensevoice-gpu-latest.tar.gz
    - docker save $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest | gzip > sensevoice-cpu-latest.tar.gz

    # 清理构建缓存
    - docker system prune -f
  artifacts:
    paths:
      - sensevoice-gpu-latest.tar.gz
      - sensevoice-cpu-latest.tar.gz
      - docker-compose.deploy.yml
      - docker-compose.yml
      - .env.example
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v.*/
    - if: $CI_PIPELINE_SOURCE == "web"
  needs:
    - job: code_quality
      optional: true

# 直接部署到 Docker（无需服务器）
deploy_docker:
  stage: deploy
  image: ${DOCKER_REGISTRY}/library/ubuntu-python-base:22.04-20240612
  before_script:
    # 安装必要工具
    - apt-get update -qq && apt-get install -y -qq curl
  script:
    # 显示构建信息
    - echo "=== 构建完成 ==="
    - echo "镜像已推送到内网仓库:" $DOCKER_REGISTRY

    # 创建部署配置
    - echo "创建部署配置..."
    - |
      cat > docker-compose.deploy.yml << EOF
      version: '3.8'
      services:
        sensevoice-gpu:
          image: $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest
          ports:
            - "50000:50000"
          environment:
            - SENSEVOICE_DEVICE=${GPU_DEVICE:-cuda}
            - SENSEVOICE_HOST=0.0.0.0
            - SENSEVOICE_PORT=50000
            - SENSEVOICE_LOG_LEVEL=INFO
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    count: 1
                    capabilities: [gpu]
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:50000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

        sensevoice-cpu:
          image: $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest
          ports:
            - "50001:50000"
          environment:
            - SENSEVOICE_DEVICE=cpu
            - SENSEVOICE_HOST=0.0.0.0
            - SENSEVOICE_PORT=50000
            - SENSEVOICE_LOG_LEVEL=INFO
          restart: unless-stopped
          healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:50000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
          profiles:
            - cpu
      EOF

    # 显示部署信息
    - echo "=== 部署信息 ==="
    - echo "GPU 镜像:" $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest
    - echo "CPU 镜像:" $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest
    - echo "部署配置:" docker-compose.deploy.yml
    - echo ""
    - echo "=== 部署命令 ==="
    - echo "# GPU 版本部署:"
    - echo "docker-compose -f docker-compose.deploy.yml up -d sensevoice-gpu"
    - echo ""
    - echo "# CPU 版本部署:"
    - echo "docker-compose -f docker-compose.deploy.yml --profile cpu up -d sensevoice-cpu"
    - echo ""
    - echo "# 查看服务状态:"
    - echo "docker-compose -f docker-compose.deploy.yml ps"
    - echo ""
    - echo "# 查看日志:"
    - echo "docker-compose -f docker-compose.deploy.yml logs -f"
  after_script:
    # 显示部署完成信息
    - echo "=== 部署配置已生成 ==="
    - echo "请下载 docker-compose.deploy.yml 文件进行部署"
    - echo "仓库地址:" $DOCKER_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v.*/
    - if: $CI_PIPELINE_SOURCE == "web"
  needs:
    - job: build_images
  environment:
    name: docker-registry
    url: https://$DOCKER_REGISTRY

# 手动触发部署（可选择跳过测试）
manual_deploy:
  stage: deploy
  extends: deploy_docker
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: false
  variables:
    ENVIRONMENT: ${ENVIRONMENT:-production}
    GPU_DEVICE: ${GPU_DEVICE:-cuda}
    FORCE_DEPLOY: ${FORCE_DEPLOY:-false}
