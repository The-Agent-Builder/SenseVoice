# SenseVoice GitLab CI/CD Pipeline
# 支持代码质量检查、Docker构建和自动部署

stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_NAME: "sensevoice"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2376
  # 内网 Docker 仓库配置
  DOCKER_REGISTRY: "hub.sensedeal.vip"
  DOCKER_IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  # 部署配置
  DEPLOY_PATH: "/opt/sensevoice"



# Docker 镜像构建
build_images:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  before_script:
    # 等待 Docker 服务启动
    - sleep 10
    - until docker info; do echo "等待 Docker 服务启动..."; sleep 5; done
    # 登录内网 Docker 仓库
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY
    - docker info
  script:
    # 构建 GPU 版本
    - echo "构建 GPU Docker 镜像..."
    - docker build -f Dockerfile.gpu -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-$DOCKER_IMAGE_TAG .
    - docker build -f Dockerfile.gpu -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest .

    # 构建 CPU 版本
    - echo "构建 CPU Docker 镜像..."
    - docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-$DOCKER_IMAGE_TAG .
    - docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest .

    # 推送镜像到内网仓库
    - echo "推送镜像到内网仓库..."
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-$DOCKER_IMAGE_TAG
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-$DOCKER_IMAGE_TAG
    - docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest

    # 保存镜像文件（用于直接部署）
    - echo "保存 Docker 镜像文件..."
    - docker save $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest | gzip > sensevoice-gpu-latest.tar.gz
    - docker save $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest | gzip > sensevoice-cpu-latest.tar.gz

    # 清理构建缓存
    - docker system prune -f
  artifacts:
    paths:
      - sensevoice-gpu-latest.tar.gz
      - sensevoice-cpu-latest.tar.gz
      - docker-compose.deploy.yml
      - docker-compose.yml
      - .env.example
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v.*/
    - if: $CI_PIPELINE_SOURCE == "web"



# SSH 部署到服务器
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    # 安装必要工具
    - apk add --no-cache openssh-client curl bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    # 传输文件到服务器
    - echo "传输文件到服务器..."
    - scp -P $SERVER_PORT sensevoice-gpu-latest.tar.gz sensevoice-cpu-latest.tar.gz docker-compose.yml .env.example $SERVER_USER@$SERVER_HOST:$DEPLOY_PATH/temp/

    # 执行部署脚本
    - |
      ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
        set -e

        # 进入部署目录
        cd $DEPLOY_PATH

        # 创建备份
        if [ -f docker-compose.yml ]; then
          echo "创建备份..."
          sudo docker-compose down || true
          cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S) || true
        fi

        # 复制新文件
        cp temp/docker-compose.yml .
        cp temp/.env.example .env

        # 设置GPU设备（如果手动指定）
        if [ "${GPU_DEVICE:-auto}" != "auto" ]; then
          echo "SENSEVOICE_DEVICE=${GPU_DEVICE}" >> .env
          echo "手动设置GPU设备: ${GPU_DEVICE}"
        fi

        # 登录内网Docker仓库
        echo "登录内网Docker仓库..."
        echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $DOCKER_REGISTRY

        # 拉取最新镜像
        echo "拉取最新镜像..."
        docker pull $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:gpu-latest
        docker pull $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME:cpu-latest

        # 清理旧镜像
        echo "清理旧镜像..."
        docker image prune -f || true

        # 启动服务
        echo "启动服务..."
        docker-compose up -d

        # 等待服务启动
        echo "等待服务启动..."
        sleep 30

        # 健康检查
        echo "执行健康检查..."
        for i in {1..10}; do
          if curl -f http://localhost:50000/health; then
            echo "服务健康检查通过!"
            break
          fi
          echo "健康检查尝试 $i 失败，10秒后重试..."
          sleep 10
        done

        # 清理临时文件
        rm -rf temp/

        echo "部署完成!"
      EOF
  after_script:
    # 显示部署状态
    - |
      ssh -p $SERVER_PORT $SERVER_USER@$SERVER_HOST << 'EOF'
        cd $DEPLOY_PATH
        echo "=== 部署状态 ==="
        docker-compose ps
        echo "=== 服务日志 (最近20行) ==="
        docker-compose logs --tail=20 sensevoice
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v.*/
    - if: $CI_PIPELINE_SOURCE == "web"
  needs:
    - job: build_images
  environment:
    name: production
    url: http://$SERVER_HOST:50000

# 手动触发部署
manual_deploy:
  stage: deploy
  extends: deploy_production
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
      allow_failure: false
  variables:
    ENVIRONMENT: ${ENVIRONMENT:-production}
    GPU_DEVICE: ${GPU_DEVICE:-cuda}
