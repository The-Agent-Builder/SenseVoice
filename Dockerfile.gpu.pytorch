# 使用官方 PyTorch CUDA 镜像（通过 docker.1ms.run 加速）
FROM docker.1ms.run/pytorch/pytorch:2.1.0-cuda12.1-cudnn8-runtime

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV LANG=C.UTF-8
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    ffmpeg \
    libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 复制项目文件
COPY requirements.txt .
COPY *.py ./
COPY config/ ./config/
COPY handlers/ ./handlers/
COPY models/ ./models/
COPY utils/ ./utils/
COPY websocket/ ./websocket/
COPY static/ ./static/
COPY scripts/ ./scripts/

# 配置 pip
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

# 安装 Python 依赖
RUN pip install --no-cache-dir \
    fastapi>=0.111.1 \
    uvicorn[standard] \
    python-multipart \
    websockets \
    python-dotenv \
    "numpy<=2.3.3" \
    "pydub>=0.25.1" \
    modelscope \
    huggingface_hub \
    "funasr>=1.1.3" \
    gradio \
    pynvml

RUN mkdir -p /root/.cache/modelscope

ENV SENSEVOICE_DEVICE=auto
ENV SENSEVOICE_HOST=0.0.0.0
ENV SENSEVOICE_PORT=50000
ENV SENSEVOICE_LOG_LEVEL=INFO
ENV PYTHONPATH=/app

# PyTorch CUDA 内存分配优化，避免显存碎片化
ENV PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${SENSEVOICE_PORT}/health || exit 1

EXPOSE 50000
CMD ["python", "main.py"]

